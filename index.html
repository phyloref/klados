<!doctype html>
<html lang="en">

<!--
		Phyloreferencing Curation Tool
		Copyright (c) The Phyloreferencing Project, 2018.

		Skeleton based on https://www.taniarascia.com/basic-html5-file/
-->

<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-size=1">

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.cs">
	<title>Phyloref Curation Tool, version 0.1</title>

	<link rel="stylesheet" href="css/main.css">
	<!--
			<link rel="icon" href="images/favicon.png">
	-->

	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

	<link href="http://veg.github.io/phylotree.js/phylotree.css" rel="stylesheet">
</head>

<body>
	<!-- Navigation bar at the top of the page -->
	<nav class="navbar navbar-default">
		<div class="container">
			<div class="navbar-header">
				<a class="navbar-brand" href="index.html">Curation Tool</a>
			</div>
		</div>
	</nav>

	<div id="app">
		<div class="col-md-12 panel">

			<!-- Menu for loading and exporting files -->
			<div class="btn-group btn-group-justified" role="group" aria-label="Options to load or save testcase">
				<div class="btn-group" role="group">
					<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						Load an example <span class="caret"></span>
					</button>
					<ul class="dropdown-menu">
					  	<li><a href="#" onclick="load_json_from_url('examples/fisher_et_al_2007.json')">Fisher <em>et al</em>, 2007</a></li>
						<li><a href="#" onclick="load_json_from_url('examples/hillis_and_wilcox_2005.json')">Hillis and Wilcox, 2005</a></li>
					  	<!-- <li role="separator" class="divider"></li> -->
					</ul>
				</div>

				<label class="btn btn-info btn-group" for="file-input" role="group">
					<input id="file-input" type="file" style="display:none;"
						onchange="load_json_from_local($('#file-input'))"
					>
					Read from local JSON file
				</label>

				<div class="btn-group" role="group">
					<button id="export-as-json" type="button" class="btn btn-success"
						onclick="$('#view-as-json').toggle(300)"
					>Export as JSON</button>
				</div>
			</div>
		</div>

		<!-- Modification warning -->
		<div id="testcase-modified" v-if="modified" class="col-md-12">
			<div class="panel panel-warning collapsible">
				<div class="panel-heading">The testcase has been modified!</div>
				<div class="panel-body">
					<p>Please take care.</p>
				</div>
			</div>
		</div>

		<!-- Displays the test case as a JSON document -->
		<div id="view-as-json" class="col-md-12" hidden>
			<div class="panel panel-success">
				<div class="panel-heading">Test case as JSON</div>
				<div class="panel-body">
					<textarea id="test-content" cols="80" rows="10" v-model="testcase_as_json"></textarea>
				</div>
			</div>
		</div>

		<!-- Metadata for the entire study -->
		<form id="study-metadata" class="form-horizontal col-md-12">
			<div class="panel panel-info">
				<div class="panel-heading">Study metadata</div>
				<div class="form-group panel-body">
					<label for="testcase-id" class="col-md-1 control-label">Testcase URI</label>
					<div class="col-md-10 input-group">
						<input id="testcase-id" type="url" class="form-control" v-model.trim="testcase['@id']" v-on:input="modified = true" placeholder="Enter URI that identifies this testcase">
					</div>

					<label for="title" class="col-md-1 control-label">Title</label>
					<div class="col-md-10 input-group">
						<input id="title" type="text" class="form-control" v-model.trim="testcase.title" v-on:input="modified = true" placeholder="Enter study title">
					</div>

					<label for="citation" class="col-md-1 control-label">Citation</label>
					<div class="col-md-10 input-group">
						<input id="citation" type="text" class="form-control" v-model.trim="testcase.citation" v-on:input="modified = true" placeholder="Enter citation">
					</div>

					<label for="url" class="col-md-1 control-label">URL</label>
					<div class="col-md-10 input-group">
						<input id="url" type="url" class="form-control" v-model.trim="testcase['url']" v-on:input="modified = true" placeholder="Enter URI/URL">
						<span class="input-group-btn">
        					<button class="btn btn-default" type="button" onclick="window.open(vm.testcase.url, '_blank')">Open in new window</button>
      					</span>
					</div>

					<label for="doi" class="col-md-1 control-label">DOI</label>
					<div class="col-md-10 input-group">
						<span class="input-group-addon">{{DOI_PREFIX}}</span>
						<input id="title" type="text" class="form-control" v-model.trim="doi_without_prefix" v-on:input="modified = true" placeholder="Enter DOI">
						<span class="input-group-btn">
							<button class="btn btn-default" type="button" onclick="window.open(vm.doi_as_url, '_blank')">Open in new window</button>
      					</span>
					</div>
				</div>
			</div>
		</form>

		<!-- Dropdown menus for navigating phylogenies and phyloreferences -->
		<div class="col-md-12 panel">
			<div class="btn-group btn-group-justified" role="group" aria-label="Options to navigate phylogenies">
				<div class="btn-group" role="group">
					<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						{{ testcase.phylogenies.length }} phylogenies <span class="caret"></span>
					</button>
					<ul class="dropdown-menu">
						<template v-for="(phylogeny, phylogeny_index) of testcase.phylogenies">
						  	<li><a :href="'#phylogeny-' + phylogeny_index">Phylogeny {{phylogeny_index + 1}}</a></li>
						</template>
						<li><a href="javascript:void(0)" onclick="vm.testcase.phylogenies.push({})"><strong>Add phylogeny</strong></a></li>
					</ul>
				</div>

				<div class="btn-group" role="group">
					<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
						{{ testcase.phylorefs.length }} phyloreferences <span class="caret"></span>
					</button>
					<ul class="dropdown-menu">
						<template v-for="(phyloref, phyloref_index) of testcase.phylorefs">
						  	<li :class="{active: selected_phyloref === phyloref}">
								<a href="javascript:void(0)" @click="selected_phyloref = phyloref">{{get_phyloref_label(phyloref)}}</a>
							</li>
						</template>
						<li><a href="javascript:void(0)" @click="testcase.phylorefs.push(create_empty_phyloref(testcase.phylorefs.length + 1))"><strong>Add phyloreference</strong></a></li>
					</ul>
				</div>
			</div>
		</div>

		<!-- Phylogeny display and Newick editing -->
		<div class="col-md-7">
			<div :id="'phylogeny-' + phylogeny_index" class="panel panel-info" v-for="(phylogeny, phylogeny_index) of testcase.phylogenies">
				<div class="panel-heading">Phylogeny {{phylogeny_index + 1}}</div>
				<div class="panel-body">
					<svg :id="'phylogeny-svg-' + phylogeny_index" :alt="get_phylogeny_as_newick('#phylogeny-svg-' + phylogeny_index, phylogeny)"></svg>
				</div>
				<div class="panel-footer">
					<textarea
						class="col-md-12"
						v-if="selected_phylogeny === phylogeny"
						placeholder="Enter Newick string for phylogeny here"
						v-model.lazy="phylogeny.newick"
						>{{get_phylogeny_as_newick('#phylogeny-svg-' + phylogeny_index, phylogeny)}}</textarea>
					<div class="btn-group btn-group-justified" role="group" aria-label="Actions for phylogeny">
						<a :href="'#phylogeny-' + phylogeny_index" @click="selected_phylogeny = (selected_phylogeny == phylogeny ? null : phylogeny)" class="btn btn-default">Edit as Newick</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Specifier modal: displays the allows editing of the current specifier -->
		<div id="specifier-modal" class="modal fade">
			<div class="modal-dialog modal-lg form-horizontal">
				<div class="modal-content" v-if="selected_specifier">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Editing specifier: {{get_specifier_label(selected_specifier)}}</h4>
					</div>
					<div class="modal-body form-group">
						<div class="col-md-12">
							<p>
								Specifiers reference a number of taxonomic units. You will usually only need to reference a
								single taxonomic specifier, but this interface allows you to examine all taxonomic units that
								this specifier references.
							</p>

							<form id="specifier">
								<div id="specifier-tunits-panel" class="panel panel-info" style="margin-top: 1em">
									<div class="panel-heading">Taxonomic Units</div>
									<div class="panel-body" v-if="!selected_tunit">
										<p><em>Select a taxonomic unit or create a new one.</em></p>
									</div>
									<div class="panel-body" v-if="selected_tunit">

										<div class="col-md-12">
											<div class="panel panel-default">
												<div class="panel-heading">Scientific names</div>
												<div class="panel-body">
													<span v-if="!selected_tunit.hasOwnProperty('scientific_names') || selected_tunit.scientific_names.length == 0">
														<em>No scientific names provided.</em>
													</span>
													<div class="input-group"
														v-if="selected_tunit.hasOwnProperty('scientific_names')"
														v-for="(scname, scname_index) of selected_tunit.scientific_names">
														<span class="input-group-btn">
															<button class="btn btn-danger" @click="selected_tunit.scientific_names.splice(scname_index, 1)"><span class="glyphicon glyphicon-remove"></span></button>
														</span>
														<input type="text" class="form-control" v-model:lazy="scname.scientific_name">
														<div class="input-group-btn">
															<button type="button"
																class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
																><span class="glyphicon glyphicon-search"></span> <span class="caret"></span></button>
															<ul class="dropdown-menu dropdown-menu-right">
																<li class="dropdown-header">Components of the scientific name</li>
																<li><a href="#" onclick="return false"><em>Entered scientific name:</em> {{scname.scientific_name}}</a></li>
																<li><a href="#" onclick="return false"><em>Binomial name:</em> {{get_binomial_name(scname)}}</a></li>
																<li><a href="#" onclick="return false"><em>Genus:</em> {{get_genus_name(scname)}}</a></li>
																<li><a href="#" onclick="return false"><em>Specific epithet:</em> {{get_specific_epithet_name(scname)}}</a></li>
															</ul>
														</div>
													</div>
												</div>
												<div class="panel-footer">
													<button class="btn btn-default"
														@click="create_or_append(selected_tunit, 'scientific_names', {'scientific_name': ''})"
														>Add a new scientific name</button>
												</div>
											</div>
										</div>

										<div class="col-md-6">
											<div class="panel panel-default">
												<div class="panel-heading">External references</div>
												<div class="panel-body">
													<span v-if="!selected_tunit.hasOwnProperty('externalReferences') || selected_tunit.externalReferences.length == 0">
														<em>No external references provided.</em>
													</span>

													<div class="input-group"
														v-if="selected_tunit.hasOwnProperty('externalReferences')"
														v-for="(external_ref, external_ref_index) of selected_tunit.externalReferences">
														<div class="input-group-btn">
															<button class="btn btn-danger" @click="selected_tunit.externalReferences.splice(external_ref_index, 1)"
																><span class="glyphicon glyphicon-remove"></span></button>
														</div>
														<input type="url" class="form-control" v-model:lazy="selected_tunit.externalReferences[external_ref_index]">
														<div class="input-group-btn">
															<button class="btn btn-primary" @click="open_url(external_ref)">Go to URL</button>
														</div>
													</div>

												</div>
												<div class="panel-footer">
													<button
														class="btn btn-default"
														style="width: 100%"
														href="#specifier-modal"
														onclick="if(!('externalReferences' in vm.selected_tunit)) Vue.set(vm.selected_tunit, 'externalReferences', []); vm.selected_tunit.externalReferences.push('http://example.org/');"
														>Add a new external reference</button>
												</div>
											</div>
										</div>

										<div class="col-md-6">
											<div class="panel panel-default">
												<div class="panel-heading">Specimens</div>
												<div class="panel-body">
													<span v-if="!selected_tunit.hasOwnProperty('includesSpecimens') || selected_tunit.includesSpecimens.length == 0">
														<em>No specimens provided.</em>
													</span>
													<div class="input-group"
														v-if="selected_tunit.hasOwnProperty('includesSpecimens')"
														v-for="(specimen, specimen_index) of selected_tunit.includesSpecimens">
														<span class="input-group-btn">
															<button class="btn btn-danger" @click="selected_tunit.includesSpecimens.splice(scname_index, 1)"><span class="glyphicon glyphicon-remove"></span></button>
														</span>
														<input type="text" class="form-control" v-model:lazy="specimen.occurrenceID">
														<div class="input-group-btn">
															<button type="button"
																class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
																><span class="glyphicon glyphicon-search"></span> <span class="caret"></span></button>
															<ul class="dropdown-menu dropdown-menu-right">
																<li class="dropdown-header">Specimen components</li>
																<li><a href="#" onclick="return false">Occurrence ID: {{specimen.occurrenceID}}</a></li>
																<li><a href="#" onclick="return false">Institution Code: {{get_institution_code(specimen)}}</a></li>
																<li><a href="#" onclick="return false">Collection Code: {{get_collection_code(specimen)}}</a></li>
																<li><a href="#" onclick="return false">Catalog Number: {{get_catalog_number(specimen)}}</a></li>
															</ul>
														</div>
													</div>
												</div>
												<div class="panel-footer">
													<button class="btn btn-default"
														@click="create_or_append(selected_tunit, 'includesSpecimens', {'occurrenceID': ''})"
														>Add a new specimen</button>
												</div>
											</div>
										</div>
									</div>

									<div class="list-group">
										<a 	class="list-group-item"
											v-if="selected_specifier.hasOwnProperty('references_taxonomic_units')"
											v-for="(tunit, tunit_index) of selected_specifier.references_taxonomic_units"
											:class="{active: selected_tunit === tunit}"
											@click="selected_tunit = tunit"
											:title="get_taxonomic_unit_label(tunit)"
										>{{get_taxonomic_unit_label(tunit)}}</a>
										<a 	class="list-group-item"
											href="javascript: void(0)"
											onclick="if(!vm.selected_specifier.hasOwnProperty('references_taxonomic_units')) vm.selected_specifier.references_taxonomic_units = []; vm.selected_specifier.references_taxonomic_units.push(vm.create_empty_taxonomic_unit(vm.selected_specifier.references_taxonomic_units.length + 1))"
											><strong>Add new taxonomic unit</strong></a>
									</div>

								</div>
							</form>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal" @click="close_specifier_modal(selected_specifier)">Close</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Phyloreference sidebar -->
		<div class="col-md-5 panel float-md-right">
			<div class="panel panel-info">
				<div id="selected-phyloref" class="panel-heading">Phyloreferences</div>
				<div v-if="selected_phyloref" class="panel-body">
					<form id="phyloref" class="form-horizontal">
						<label for="label" class="control-label col-md-4">Label</label>
						<div class="input-group col-md-8">
							<input id="label" v-model="selected_phyloref.label" type="text" class="form-control"  placeholder="Phyloreference label">
						</div>

						<label for="definition" class="control-label col-md-4">Definition</label>
						<div class="input-group col-md-8">
							<textarea
								id="definition"
								v-model="selected_phyloref.cladeDefinition"
								class="form-control"
								rows="8"
								placeholder="Phylogenetic clade definition"
								></textarea>
						</div>

						<div class="panel panel-info" style="margin-top: 1em">
							<div class="panel-heading">Specifiers</div>
							<div class="panel-body">
								<div class="input-group"
									v-if="selected_phyloref"
									v-for="(specifier, specifier_index) of get_specifiers(selected_phyloref)"
									:id="'specifier_' + specifier_index"
								>
									<div class="input-group-btn">
										<button v-if="specifier_delete_mode" type="button"
											class="btn btn-danger"
											@click="delete_specifier(selected_phyloref, specifier)"
											><span class="glyphicon glyphicon-remove"></span></button>
										<button
											@click="specifier_dropdown_target = 'match_result'"
											type="button" class="btn btn-warning dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
											<span class="glyphicon glyphicon-asterisk"></span>
										</button>
										<button
											@click="specifier_dropdown_target = 'specifier_type'"
											type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
											> {{get_specifier_type(selected_phyloref, specifier)}} <span class="caret"></span></button>
										<ul v-if="specifier_dropdown_target == 'specifier_type'" class="dropdown-menu dropdown-menu-left">
											<li class="dropdown-header">Specifier type</li>
											<li :class="{active: get_specifier_type(selected_phyloref, specifier) == 'Internal'}"
												><a :href="'#specifier_' + specifier_index"
													@click="set_specifier_type(selected_phyloref, specifier, 'Internal')"
												>Internal specifier</a></li>
											<li :class="{active: get_specifier_type(selected_phyloref, specifier) == 'External'}"
												><a :href="'#specifier_' + specifier_index"
													@click="set_specifier_type(selected_phyloref, specifier, 'External')"
												>External specifier</a></li>
										</ul>
										<ul v-if="specifier_dropdown_target == 'match_result'" class="dropdown-menu dropdown-menu-left">
											<li class="dropdown-header">Match result</li>
											<li><a href="#" onclick="return false;"><em>Matching not implemented.</em></a></li>
										</ul>
									</div>
									<input type="text" disabled class="form-control" :value="get_specifier_label(specifier)" :title="get_specifier_label(specifier)">
									<div class="input-group-btn">
										<button type="button"
											class="btn btn-primary"
											@click="start_specifier_modal(specifier)"
											><span class="glyphicon glyphicon-edit"></span></button>
									</div>
								</div>
							</div>
							<div class="panel-footer">
								<button
									type="button"
									class="btn btn-default"
									onclick="if(!vm.selected_phyloref.hasOwnProperty('externalSpecifiers')) vm.selected_phyloref.externalSpecifiers = []; vm.selected_phyloref.externalSpecifiers.push({});"
								>Add new specifier</button>
								<button
									type="button"
									class="btn btn-default"
									@click="specifier_delete_mode = !specifier_delete_mode"
								>Delete some specifiers</button>
							</div>
						</div>

						<!-- Old-timey select lists of Specifiers. TBD. -->
						<!--
						<label for="internal-specifiers" class="control-label col-md-4">Internal specifiers</label>
						<div class="input-group col-md-8">
							<select id="internal-specifiers" class="form-control col-md-8" multiple>
								<option
									v-for="(specifier, specifier_index) of selected_phyloref.internalSpecifiers"
									@click="selected_specifier = specifier"
									ondblclick="$('#specifier-modal').modal()"
									>{{get_specifier_label(specifier)}}</option>
								<option ondblclick="new_specifier = vm.create_empty_specifier(vm.selected_phyloref.internalSpecifiers.length + 1); vm.selected_phyloref.internalSpecifiers.push(new_specifier); vm.selected_specifier = new_specifier; $('#specifier-modal').modal();"
									>(Add more)</option>
							</select>
						</div>

						<label for="external_specifiers" class="control-label col-md-4">External specifiers</label>
						<div class="input-group col-md-8">
							<select id="external_specifiers" class="form-control col-md-8" multiple>
								<option
									v-for="(specifier, specifier_index) of selected_phyloref.externalSpecifiers"
									@click="selected_specifier = specifier"
									ondblclick="$('#specifier-modal').modal()"
									>{{get_specifier_label(specifier)}}</option>
								<option ondblclick="new_specifier = vm.create_empty_specifier(vm.selected_phyloref.externalSpecifiers.length + 1); vm.selected_phyloref.externalSpecifiers.push(new_specifier); vm.selected_specifier = new_specifier; $('#specifier-modal').modal();"
									>(Add more)</option>
							</select>
						</div>
						-->
					</form>
				</div>


				<div class="list-group">
					<a 	href="#selected-phyloref"
						class="list-group-item"
						v-for="(phyloref, phyloref_index) of testcase.phylorefs"
						:class="{active: selected_phyloref === phyloref}"
						@click="selected_phyloref = phyloref"
					>{{phyloref.hasOwnProperty('label') ? phyloref.label : 'Phyloreference ' + (phyloref_index + 1)}}</a>
					<a class="list-group-item" href="javascript: void(0)" @click="testcase.phylorefs.push(create_empty_phyloref(testcase.phylorefs.length + 1))"><strong>Add phyloreference</strong></a>
				</div>
			</div>
		</div>
	</div>

	<!-- End of page UI -->

	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
	<script
		src="https://code.jquery.com/jquery-3.3.1.min.js"
		integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
		crossorigin="anonymous"
	></script>
	<script
		src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"
	></script>
	<script
		src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
		integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
		crossorigin="anonymous"
	></script>
	<script
		src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"
	></script>

	<!-- Phylotree -->
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://veg.github.io/phylotree.js/phylotree.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" charset="utf-8"></script>

	<!-- Our source code -->
	<script src="./js/curation-tool.js"></script>
</body>

</html>
